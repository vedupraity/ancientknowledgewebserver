name: Build and Deploy

on:
  workflow_dispatch:
  schedule:
    - cron:  '30 11 * * *' # 5:00 PM IST Everyday
  # TODO: remove the push event after testing
  push:
    branches:
      - feature/github-build-matrix

concurrency: 
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-recent-commits:
    name: Check recent commits
    runs-on: ubuntu-latest
    outputs:
      hasCommitsInDatabase: ${{ steps.check-new-commits-in-database.outputs.has-new-commits }}
      hasCommitsInWebserver: ${{ steps.check-new-commits-in-webserver.outputs.has-new-commits }}
    steps:
      - uses: actions/checkout@v2
        with:
          repository: vedupraity/ancientknowledgedatabase
          ref: master
          token: ${{ secrets.PAT_GITHUB_REPO }}
      
      - name: Check commits in ancientknowledgedatabase since 24 hours ago
        id: check-new-commits-in-database
        run: |
          if [[ "$(git log --since='24 hours ago')" != "" ]]; then
            echo "::set-output name=has-new-commits::true"
          else
            echo "::set-output name=has-new-commits::false"
          fi
      
      - uses: actions/checkout@v2
        with:
          repository: vedupraity/ancientknowledgewebserver
          ref: master
          token: ${{ secrets.PAT_GITHUB_REPO }}
      
      - name: Check commits in ancientknowledgewebserver since 24 hours ago
        id: check-new-commits-in-webserver
        run: |
          if [[ "$(git log --since='24 hours ago')" != "" ]]; then
            echo "::set-output name=has-new-commits::true"
          else
            echo "::set-output name=has-new-commits::false"
          fi

  generate-freeze-candidate:
    name: Generate Freeze Candidates
    if: ${{ needs.CheckRecentCommits.outputs.hasCommitsInDatabase == 'true' || needs.CheckRecentCommits.outputs.hasCommitsInWebserver == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      build_job_ids: ${{ steps.generate-free-candidate-urls.outputs.build_ids }}
    steps:
      - uses: actions/checkout@v2
      
      - uses: actions/setup-python@v2
        with:
          python-version: "3.10.2"
          architecture: "x64"
      
      - name: Install dependencies
        run: |
          pip3 install -r requirements.txt

      - name: Generate Freeze Candidate URLs
        id: generate-free-candidate-urls
        run: |
          source .env.prod
          python generate_urls.py

          echo "::set-output name=build_job_ids::$(cat build_job_ids.json | jq -c)"

      - name: Cache Freeze Candidates
        uses: actions/cache@v2
        with:
          path: |
            build_job_ids.json
            urls_per_build_job.json
          key: freeze-candidates-${{ github.run_number }}

  freeze-urls:
    name: Freeze URLs
    runs-on: ubuntu-latest
    needs: [generate-freeze-candidate]
    strategy:
      matrix:
        id: ${{ fromJson(needs.generate-freeze-candidate.outputs.build_job_ids) }}
    steps:
      - run: |
          build_job_id=${{ matrix.id }}
          
          # TODO: Remove this after testing
          echo $build_job_id

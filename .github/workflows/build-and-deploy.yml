name: Build and Deploy

on:
  workflow_dispatch:
  schedule:
    - cron:  '30 18 * * *' # 12:00 AM IST

jobs:
  CheckRecentCommits:
    runs-on: ubuntu-latest
    outputs:
      hasCommitsInDatabase: ${{ steps.check-new-commits-in-database.outputs.has-new-commits }}
      hasCommitsInWebserver: ${{ steps.check-new-commits-in-webserver.outputs.has-new-commits }}
    steps:
      - uses: actions/checkout@v2
        with:
          repository: vedupraity/ancientknowledgedatabase
          ref: master
          token: ${{ secrets.PAT_GITHUB_REPO }}
      - name: Check commits in ancientknowledgedatabase since 24 hours ago
        id: check-new-commits-in-database
        run: |
          if [[ "$(git log --since='24 hours ago')" != "" ]]; then
            echo "::set-output name=has-new-commits::true"
          else
            echo "::set-output name=has-new-commits::false"
          fi
      - uses: actions/checkout@v2
        with:
          repository: vedupraity/ancientknowledgewebserver
          ref: master
          token: ${{ secrets.PAT_GITHUB_REPO }}
      - name: Check commits in ancientknowledgewebserver since 24 hours ago
        id: check-new-commits-in-webserver
        run: |
          if [[ "$(git log --since='24 hours ago')" != "" ]]; then
            echo "::set-output name=has-new-commits::true"
          else
            echo "::set-output name=has-new-commits::false"
          fi

  Build:
    needs: CheckRecentCommits
    if: ${{ needs.CheckRecentCommits.outputs.hasCommitsInDatabase == 'true' || needs.CheckRecentCommits.outputs.hasCommitsInWebserver == 'true' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v2
        with:
          repository: vedupraity/ancientknowledgewebserver
          ref: master
          token: ${{ secrets.PAT_GITHUB_REPO }}

      - uses: actions/setup-python@v2
        with:
          python-version: "3.8"
          architecture: "x64"

      - name: 📥 Install
        run: |
          echo "using: $(python3 --version) and $(pip3 --version)"
          pip3 install -r requirements.txt

      - name: ⚒️ Build
        run: |
          source .env.prod && python freeze.py
          echo "finished building all static files"
          du -h -d 1 build

      - name: 💼 Minify
        run: |
          css-html-js-minify --multiple --overwrite ./build
          echo "finished optimizing build for production"
          du -h -d 1 build

      - name: Cache build directory
        uses: actions/cache@v2
        with:
          path: ./build
          key: cache-build-dir-${{ github.run_number }}

  Deploy:
    needs: Build
    if: ${{ needs.CheckRecentCommits.outputs.hasCommitsInDatabase == 'true' || needs.CheckRecentCommits.outputs.hasCommitsInWebserver == 'true' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check out repo - ancientknowledgewebsite
        uses: actions/checkout@v2
        with:
          repository: vedupraity/ancientknowledgewebsite
          ref: master
          token: ${{ secrets.PAT_GITHUB_REPO }}

      - name: Cache build directory
        uses: actions/cache@v2
        with:
          path: ./build
          key: cache-build-dir-${{ github.run_number }}

      - name: 🚀 Deploy
        env:
          GITHUB_RUN_NUMBER: ${{ env.GITHUB_RUN_NUMBER }}
        run: |
          cp -rf build/* . && rm -rf build

          date_now_utc="$(date -u)"
          release_name="release-$GITHUB_RUN_NUMBER"
          echo "$release_name ($date_now_utc)">version.txt

          git config user.email "${{ secrets.GIT_USER_EMAIL }}"
          git config user.name "${{ secrets.GIT_USER_NAME }}"
          git status
          git add .
          git commit -m "$release_name ($date_now_utc)"
          git push origin master

  PostDeploy:
    needs: Deploy
    if: ${{ needs.CheckRecentCommits.outputs.hasCommitsInDatabase == 'true' || needs.CheckRecentCommits.outputs.hasCommitsInWebserver == 'true' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: 🧹 Purge cloudflare cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_PURGE_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
